import json
import requests


meta_data_url = 'http://169.254.169.254/latest/'

## below function will validate if input is a valid json or not
def json_validator(json_input):
    try:
        json.loads(json_input)
    except ValueError:
        return False
    return True


def walk_the_tree(url,arr):
    output={}
    
    for item in arr:
        updated_url= url+item
        response = requests.get(updated_url)
        text=response.text 
        if item[-1] == '/':
            next_level_items = text.splitlines()
            output[item[:-1]]= walk_the_tree(updated_url,next_level_items)
        elif json_validator(text):
            output[item] = json.loads(text)
        else:
            output[item] = text
    return output

        
            
def ec2_meta_data():
    first_step=["meta-data/"]
    output=walk_the_tree(meta_data_url,first_step)
    return output

def ec2_meta_data_json():
    non_json_metadata=ec2_meta_data()
    try:
        json_metadata=json.loads(non_json_metadata)
    except TypeError:
        return non_json_metadata
    return json_metadata

## Function to pull desired data only
def ec2_desired_meta_date(desired_data):
    first_step=['meta-data/']
    desired_step=[first_step[0] + desired_data]
    output=walk_the_tree(meta_data_url,desired_step)
    return output




################ OUTPUT ###################


if __name__ == '__main__':
    # printing ec2 metadata as json 
    print(ec2_meta_data_json())

    # code allows for a particular data key to be retrieved individually
    #I have made it interactive 
    key=''
    while key != 'exit':
        print("To exit the prog, type 'exit' ")
        key=input("Which meta-data you want to pull \n -> ")
        valid_inputs=['ami-id', 'ami-launch-index', 'ami-manifest-path', 'block-device-mapping/', 'events/', 'hostname', 'identity-credentials/', 'instance-action', 'instance-id', 'instance-life-cycle', 'instance-type', 'local-hostname', 'local-ipv4', 'mac', 'metrics/', 'network/', 'placement/', 'profile', 'public-hostname', 'public-ipv4', 'public-keys/', 'reservation-id', 'security-groups']
        
        if key in valid_inputs:
            print(f'  {ec2_desired_meta_date(key)}  \n')
        else:
            print("Please input correct value ")




